<!DOCTYPE html>
<!--

  [Please Enter New Password]

  fortnight

  [Error: Password is Two Week]

-->
<html lang="en">
  <head>
    <title>Derived Instances Can Break Smart Constructors, Too</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Smart constructors help guard against invalid data flowing through your system and prevent the need for more pervasive defensive coding tactics. You just need to be aware of the language details which can circumvent the protection they provide.">
    <meta name="author" content="Jezen Thomas">
    <meta property="og:title" content="Derived Instances Can Break Smart Constructors, Too">
    <meta property="og:description" content="Smart constructors help guard against invalid data flowing through your system and prevent the need for more pervasive defensive coding tactics. You just need to be aware of the language details which can circumvent the protection they provide.">
    <meta property="og:type" content="article">
    <meta property="og:image" content="/static/img/relational.jpg">
    <meta property="og:site_name" content="Jezen Thomas">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="jezenthomas.com">
    <meta name="twitter:title" content="Derived Instances Can Break Smart Constructors, Too">
    <meta name="twitter:description" content="Smart constructors help guard against invalid data flowing through your system and prevent the need for more pervasive defensive coding tactics. You just need to be aware of the language details which can circumvent the protection they provide.">
    <meta name="twitter:image" content="/static/img/relational.jpg">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/gif" href="/doom.gif">
    <link rel="stylesheet" type="text/css" href="/css/8dd7495893b5a187b3cbbe8b46043572.css">
    <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="RSS feed">
  </head>
  <body>
    <div class="about">

  <a class="portrait" href="/">
    <img alt="Jezen Thomas" src="/static/img/jgt.jpg">
  </a>

  <h1 class="site-title">
    <a href="/">Jezen Thomas</a>
  </h1>

  <p class="bio">
    CTO &amp; Co-Founder at <a href="https://supercede.com">Supercede</a>.
    Haskell programmer.
    Writing about business and software engineering.
    Working from anywhere.
  </p>

  <nav>
    <ul>
      <li>
        <a href="/">Home</a>
      </li>
      <li>
        <a aria-current="true" href="/posts">Blog</a>
      </li>
      <li>
        <a href="/about">About</a>
      </li>
      <li id="bmac">
        <a href="https://buymeacoffee.com/jezen">Buy me a coffee</a>
      </li>
    </ul>
  </nav>

  <footer>&copy; 2023 Jezen Thomas</footer>

</div>

    <div id="main"><div class="container">
  <article>
    <h1 class="post-title">Derived Instances Can Break Smart Constructors, Too</h1>
    <div class="post-meta">
      <p class="post-date">
        June  9<sup>th</sup>, 2023
        
        | Kraków, Poland
        
      </p>
    </div>
    <p>You know that <em>primitive obsession</em> is an anti-pattern.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Bad, because it's &quot;stringly typed&quot;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">validPassword ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>validPassword password <span class="ot">=</span> <span class="co">-- …</span></span></code></pre></div>
<p>We’re using a <code>Text</code> value to represent a user’s password. This is bad because
there are so many possible <code>Text</code> values which would not be valid passwords.</p>
<p>For example, <code>"letmein"</code> is too short to be a valid password.</p>
<p>Ideally, you want to parse values into narrower types at the boundaries of your
system. This saves you from having to program defensively throughout your
codebase.</p>
<p>To this end, you introduce a new type which wraps a text value and models the
concept of a password.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Password</span> <span class="ot">=</span> <span class="dt">Password</span> {<span class="ot"> unPassword ::</span> <span class="dt">Text</span> }</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ot">validPassword ::</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>validPassword password <span class="ot">=</span> <span class="co">-- …</span></span></code></pre></div>
<p>This is better, but it’s still pretty weak. We’ve introduced a different name
in the type signature so it’s harder to confuse this value for some other
text value. The problem is that you can construct a <code>Password</code> value from
literally <em>any</em> text value. This leads to invalid values floating through your
system.</p>
<p>We can fix that by writing a <a href="https://kowainik.github.io/posts/haskell-mini-patterns#smart-constructor">smart constructor</a>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Careful what we export from this module. Hide that constructor.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Model.Password</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Password</span>    <span class="co">-- abstract, hiding the constructor</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  , unPassword  <span class="co">-- unwrap a password</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  , password    <span class="co">-- only way to build a password</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">where</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Our type wraps a Text value. No record field here!</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Password</span> <span class="ot">=</span> <span class="dt">Password</span> <span class="dt">Text</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Unwrap a 'Password'</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="ot">unPassword ::</span> <span class="dt">Password</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>unPassword (<span class="dt">Password</span> p) <span class="ot">=</span> p</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- Try to construct a 'Password'</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="ot">password ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">Text</span> <span class="dt">Password</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>password t</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="fu">length</span> t <span class="op">&lt;</span> <span class="dv">8</span>    <span class="ot">=</span> <span class="dt">Left</span> <span class="st">&quot;Password is too short&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="fu">length</span> t <span class="op">&gt;</span> <span class="dv">64</span>   <span class="ot">=</span> <span class="dt">Left</span> <span class="st">&quot;Password is too long&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> t <span class="op">==</span> <span class="st">&quot;password&quot;</span> <span class="ot">=</span> <span class="dt">Left</span> <span class="st">&quot;Password is too predictable&quot;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="fu">otherwise</span>       <span class="ot">=</span> <span class="dt">Right</span> (<span class="dt">Password</span> t)</span></code></pre></div>
<p>This module uses explicit exports, because it’s important that the value
constructor for <code>Password</code> remains internal to this module. The only way the we
can construct a <code>Password</code> value outside of this module is by applying the
exposed <code>password</code> function.</p>
<p>The <code>newtype</code> declaration does not have a record field, because <a href="https://taylor.fausak.me/2018/03/16/record-fields-break-smart-constructors/">record fields
break smart constructors</a>. Instead, we introduce another simple function for
unwrapping the <code>newtype</code> to get to the text value underneath<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>The <code>password</code> function guards against a few invalid cases and allows us to
construct a valid <code>Password</code> value<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. This is what people mean when they say
<em>correct by construction</em>.</p>
<p>This is a solid improvement over the <em>stringly typed</em> approach that we started
with, but there’s another potential pitfall that I ran into while refactoring
some code recently.</p>
<p>In a web application you often want to serialise and deserialise values between
different representations, <em>e.g.</em>, JSON, XML, URI path pieces, <em>etc.</em> This is
typically done with typeclasses — you have a typeclass called <code>FromJSON</code> with a
polymorphic method which parses some JSON into some other type, and then you
write an <em>instance</em> of that typeclass for each type that you’d like to apply
that parsing function to.</p>
<p>When you have a <code>newtype</code> which wraps some primitive text value, it can be
tempting to ask the compiler to <em>derive</em> the <code>FromJSON</code> instance using the
<code>GeneralizedNewtypeDeriving</code> language extension. It’s less code to write and
maintain, and in many cases you will indeed want a typeclass instance that is
the same as the instance of the underlying type.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Password</span> <span class="ot">=</span> <span class="dt">Password</span> <span class="dt">Text</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">FromJSON</span> <span class="co">-- here's your problem</span></span></code></pre></div>
<p>When you’re using smart constructors however, this will lead to invalid data
flowing through your system because like record fields, this is also a way to
circumvent the validation performed by the smart constructor.</p>
<p>Potentially adding to the confusion, we’re not protected by our careful use of
module exports here. Typeclass instances in Haskell are always exported and
imported between modules!</p>
<p>Fixing this is simple — just manually write the instance.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE LambdaCase #-}</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Password</span> <span class="ot">=</span> <span class="dt">Password</span> <span class="dt">Text</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">Password</span> <span class="kw">where</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  parseJSON <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">String</span> p) <span class="ot">-&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> password p <span class="kw">of</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Left</span> err <span class="ot">-&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fail</span> <span class="op">$</span> <span class="st">&quot;Could not parse Password: &quot;</span> <span class="op">&lt;&gt;</span> unpack p <span class="op">&lt;&gt;</span> <span class="st">&quot;; &quot;</span> <span class="op">&lt;&gt;</span> err <span class="op">&lt;&gt;</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Right</span> pass' <span class="ot">-&gt;</span> <span class="fu">pure</span> pass'</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> <span class="fu">fail</span> <span class="st">&quot;Could not parse Password - was not a String&quot;</span></span></code></pre></div>
<p>Despite these two pitfalls, smart constructors are a good return on investment.
Just be sure you don’t accidentally introduce ways to circumvent the protection
that they provide.</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>You probably never want to do this with a <em>password</em>, but you often need
to unwrap a value like this to do something with the underlying value, like
print it on the screen (or, a web page).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>You could also have this produce a <code>Maybe Password</code>, but the extra
context around why validation can fail here is interesting.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

  </article>
</div>
</div>

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37713515-1', 'auto');
    ga('send', 'pageview');
    </script>

    <script type="text/javascript">
      [].slice.call(document.querySelectorAll('.footnote-ref sup')).forEach(function(el) {
        var content = el.innerText;
        el.innerText = '[' + content + ']';
      })
    </script>
    <script defer src="/static/js/katex/katex.min.js"></script>
    <script defer src="/static/js/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
  </body>
</html>
