<!DOCTYPE html>
<!--

  [Please Enter New Password]

  fortnight

  [Error: Password is Two Week]

-->
<html lang="en">
  <head>
    <title>Rewriting Routes in Yesod</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Routes that are clear and comprehensible to the user are fundamental to good web application design. With a bit of care, we can tidy up some routes that would typically be noisy in a Yesod application.">
    <meta name="author" content="Jezen Thomas">
    <meta property="og:title" content="Rewriting Routes in Yesod">
    <meta property="og:description" content="Routes that are clear and comprehensible to the user are fundamental to good web application design. With a bit of care, we can tidy up some routes that would typically be noisy in a Yesod application.">
    <meta property="og:type" content="article">
    <meta property="og:image" content="/static/img/prestiz.jpg">
    <meta property="og:site_name" content="Jezen Thomas">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="jezenthomas.com">
    <meta name="twitter:title" content="Rewriting Routes in Yesod">
    <meta name="twitter:description" content="Routes that are clear and comprehensible to the user are fundamental to good web application design. With a bit of care, we can tidy up some routes that would typically be noisy in a Yesod application.">
    <meta name="twitter:image" content="/static/img/prestiz.jpg">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/gif" href="/doom.gif">
    <link rel="stylesheet" type="text/css" href="/css/8dd7495893b5a187b3cbbe8b46043572.css">
    <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="RSS feed">
  </head>
  <body>
    <div class="about">

  <a class="portrait" href="/">
    <img alt="Jezen Thomas" src="/static/img/jgt.jpg">
  </a>

  <h1 class="site-title">
    <a href="/">Jezen Thomas</a>
  </h1>

  <p class="bio">
    CTO &amp; Co-Founder at <a href="https://supercede.com">Supercede</a>.
    Haskell programmer.
    Writing about business and software engineering.
    Working from anywhere.
  </p>

  <nav>
    <ul>
      <li>
        <a href="/">Home</a>
      </li>
      <li>
        <a aria-current="true" href="/posts">Blog</a>
      </li>
      <li>
        <a href="/about">About</a>
      </li>
      <li id="bmac">
        <a href="https://buymeacoffee.com/jezen">Buy me a coffee</a>
      </li>
    </ul>
  </nav>

  <footer>&copy; 2023 Jezen Thomas</footer>

</div>

    <div id="main"><div class="container">
  <article>
    <h1 class="post-title">Rewriting Routes in Yesod</h1>
    <div class="post-meta">
      <p class="post-date">
        January 22<sup>nd</sup>, 2020
        
        | Kaliningrad, Russia
        
      </p>
    </div>
    <p>User authentication in Yesod typically works through a plugin system, also
known as a <em>subsite</em>. This is handy because it means your web application can
support multiple methods of authentication simultaneously and you can also swap
out one system for another relatively painlessly.</p>
<p>One drawback of this system however is the routes end up looking quite verbose.
For example, a user of your website might expect the login route to be located
at <code>/login</code>. With the plugin system however, that page will be located at
<code>/auth/page/foo/login</code>, where <code>foo</code> is the name of the plugin the user intends
to use.</p>
<p>Since Yesod runs on <a href="https://hackage.haskell.org/package/wai">WAI</a>, we can solve the problem of verbose routes by
rewriting them with a WAI middleware. This is pretty straightforward and of
course works for more than just authentication routes, though they make for a
good example.</p>
<p>The first step is pulling in the right library. The functions we want to use
are in <a href="https://hackage.haskell.org/package/wai-extra">wai-extra</a>, so add that to your cabal file if it isn’t
already there. If you used a template like <a href="https://github.com/commercialhaskell/stack-templates/blob/master/yesod-postgres.hsfiles">yesod-postgres</a> to start
your project, you likely already have this package available.</p>
<p>Next we need to override the way Yesod renders routes for us. The Yesod
typeclass exposes a method called <a href="http://hackage.haskell.org/package/yesod-core-1.6.17/docs/Yesod-Core.html#v:urlParamRenderOverride"><code>urlParamRenderOverride</code></a>. We can
use this to translate a typesafe route into whatever other string
representation we need, while also retaining any query string parameters passed
along.</p>
<p>The example below changes the way auth routes from the
<a href="https://github.com/riskbook/yesod-auth-simple">yesod-auth-simple</a> auth plugin are rendered. Your own implementation
may slightly differ.</p>
<pre><code>instance Yesod App where

  -- other typeclass method overrides

  urlParamRenderOverride y r _ =
    let root = fromMaybe &quot;&quot; (appRoot (appSettings y))
        toRoute p = Just $ uncurry (joinPath y root) (p, [])
     in case r of
          (AuthR LoginR)               -&gt; toRoute [&quot;login&quot;]
          (AuthR LogoutR)              -&gt; toRoute [&quot;logout&quot;]
          (AuthR (PluginR &quot;simple&quot; p)) -&gt; toRoute p
          _                            -&gt; Nothing

  -- yet more custom stuff</code></pre>
<p>Finally, we want to intercept user requests to the shortened paths and expand
them to their full form under the hood. This is where our WAI middleware comes
in. Pay special attention to the final pattern match of the <code>rw</code> function — you
want all other routes in your application to pass through unaltered.</p>
<pre><code>import Network.Wai.Middleware.Rewrite (rewritePureWithQueries)

rewriteAuthRoutes :: Middleware
rewriteAuthRoutes = rewritePureWithQueries rw
  where
    plugin :: [Text]
    plugin = [&quot;auth&quot;, &quot;page&quot;, &quot;simple&quot;]

    rw :: PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries
    rw ([&quot;register&quot;], _) _                  = (plugin &lt;&gt; [&quot;register&quot;], [])
    rw ([&quot;confirm&quot;, token], _) _            = (plugin &lt;&gt; [&quot;confirm&quot;, token], [])
    rw ([&quot;confirmation-email-sent&quot;], _) _   = (plugin &lt;&gt; [&quot;confirmation-email-sent&quot;], [])
    rw ([&quot;login&quot;], _) _                     = (plugin &lt;&gt; [&quot;login&quot;], [])
    rw ([&quot;reset-password&quot;], _) _            = (plugin &lt;&gt; [&quot;reset-password&quot;], [])
    rw ([&quot;reset-password-email-sent&quot;], _) _ = (plugin &lt;&gt; [&quot;reset-password-email-sent&quot;], [])
    rw ([&quot;logout&quot;], _) _                    = ([&quot;auth&quot;, &quot;logout&quot;], [])
    rw (path, qs) _                         = (path, qs)

makeApplication :: App -&gt; IO Application
makeApplication foundation = do
  logWare  &lt;- makeLogWare foundation
  appPlain &lt;- toWaiAppPlain foundation
  initState foundation
  let middlewares = defaultMiddlewaresNoLogging
                &gt;&gt;&gt; logWare
                &gt;&gt;&gt; rewriteAuthRoutes
  return $ middlewares appPlain</code></pre>
<p>Connect your custom WAI middleware to our middleware chain when building the
application, and everything should work as you expect.</p>

  </article>
</div>
</div>

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37713515-1', 'auto');
    ga('send', 'pageview');
    </script>

    <script type="text/javascript">
      [].slice.call(document.querySelectorAll('.footnote-ref sup')).forEach(function(el) {
        var content = el.innerText;
        el.innerText = '[' + content + ']';
      })
    </script>
    <script defer src="/static/js/katex/katex.min.js"></script>
    <script defer src="/static/js/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
  </body>
</html>
